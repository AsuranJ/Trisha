name: Windows build trial

on:
  push:
    branches:
      - master

jobs:
  build-win:
    runs-on: windows-latest
    continue-on-error: true
    steps:
    - uses: actions/checkout@v1
    - name: Set up Python 3.8
      uses: actions/setup-python@v1
      with:
        python-version: 3.8
    - name: Install deps
      run: |
        python -m pip install py2exe pyinstaller
    - name: Build using py2exe
      continue-on-error: true
      run: |
        python -m py2exe setup.py
        ls
    - name: Build using pyinstaller
      continue-on-error: true
      run: |
        python -m PyInstaller --distpath . -n youtube-dl -c youtube_dl/__main__.py
        ls ./youtube-dl
        ls C:\hostedtoolcache\windows\Python\3.8.5\x64
        ./youtube-dl/youtube-dl --simulate https://youtu.be/0d4-azwtoHc
    - name: Test WSL
      continue-on-error: true
      run: |
        curl -Lo ubuntu.appx https://aka.ms/wslubuntu2004
        Add-AppxPackage ubuntu.appx
        bash apt update
        bash apt install wget
        bash wget -qO- checkip.amazonaws.com
  build-linux:
    runs-on: ubuntu-20.04
    continue-on-error: true
    steps:
    - uses: actions/checkout@v1
    - name: Set up Python 3.8
      uses: actions/setup-python@v1
      with:
        python-version: 3.8
    - name: Install deps
      run: |
        mkdir -p wine-root/drive_c/py/ wine-root/drive_c/dist/
        sudo dpkg --add-architecture i386
        wget -O- https://dl.winehq.org/wine-builds/winehq.key | sudo apt-key add -
        sudo add-apt-repository 'deb https://dl.winehq.org/wine-builds/ubuntu/ focal main'
        sudo apt update
        sudo apt install --no-install-recommends -y wine64
        wget https://www.python.org/ftp/python/3.7.9/python-3.7.9-embed-amd64.zip \
             https://www.python.org/ftp/python/3.7.9/python-3.7.9-amd64.exe \
             https://www.python.org/ftp/python/3.7.9/python-3.7.9-amd64-webinstall.exe \
             https://github.com/python/cpython/archive/v3.7.9.zip
    - name: Install deps 2
      uses: GabrielBB/xvfb-action@v1
      continue-on-error: true
      with:
        run: |
          true wine64-stable python-3.7.9-amd64.exe \
              /quiet /passive /log "c:\\p.log" TargetDir="C:\\py" \
              InstallAllUsers=0 Include_doc=0 Include_debug=0 Include_dev=0 \
              Include_exe=1 Include_launcher=0 Include_lib=1 Include_pip=1 \
              Include_symbols=0 Include_tcltk=0 Include_test=0 Include_tools=0
    - name: Install deps 3
      run: |
        export WINEPREFIX="$(realpath wine-root/)" WINEARCH=win64 WINEDEBUG=-all
        unzip -d wine-root/drive_c/py/ python-3.7.9-embed-amd64.zip
        mkdir -p wine-root/drive_c/py/Lib/
        unzip -d wine-root/drive_c/py/Lib/ wine-root/drive_c/py/python37.zip
        unzip v3.7.9.zip
        mv cpython-3.7.9/Include/ wine-root/drive_c/py/include/
        wget https://gist.github.com/nao20010128nao/f7699617e28344fe7812d53de5af6732/raw/81bb9a68ce40cd92fad83fde746ac7de4452bbaa/pyconfig.h -O wine-root/drive_c/py/include/pyconfig.h
        wget https://bootstrap.pypa.io/get-pip.py -O wine-root/drive_c/py/get-pip.py
        wine64-stable "C:\\py\\python.exe" "C:\\py\\get-pip.py"
        rm wine-root/drive_c/py/python37._pth wine-root/drive_c/py/python37.zip
        wine64-stable "C:\\py\\python.exe" -m pip install pyinstaller
        wine64-stable "C:\\py\\python.exe" -m PyInstaller --distpath "C:\\dist\\" -n youtube-dl -c youtube_dl/__main__.py
        ls "$WINEPREFIX/drive_c/dist/youtube-dl"
        file "$WINEPREFIX/drive_c/dist/youtube-dl"
